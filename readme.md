# 工业产品的视觉测量和外观检测

为了记录学习过程，打算给这个项目写一个流程介绍。

## 1. 总体介绍

运用机器视觉方法，通过OpenCV进行工业样品的测量和缺陷检测。具体为两个任务：

- **任务一**：用亚像素边缘检测方法，测量一批样品的边缘是否为严格的矩形，并画出`data/measure`目录下全部产品的高度，宽度，矩形度的分布，均值和方差；
- **任务二**：对另一批样品做三个层次的缺陷检测，主要包括图像级别（样品是否为缺陷样品）、缺陷级别（标注出缺陷的大致位置）和像素级别（对每个像素是否为缺陷做二分类，最终将缺陷图像二值化）。

### 数据介绍

- 在 `data/measure` 目录下，存有任务一的样品图。样品在图像的正中心，呈现黑色；样品的摆放角度略微倾斜；图像背景为纯白，并且底部存在着无关部分。
- 在 `data/defect` 目录下，存有任务二的样品图，包含了缺陷（NG）和无缺陷（OK）两类样品。无缺陷样品只有图片，有缺陷的样品包括了图片和缺陷标签两种数据。

---

## 2. 图片的矩形度评估

对图片的矩形度评估分为三个阶段，依次为倾斜校正、边缘检测和矩形度的计算。

### 2.1 图像的倾斜校正

先读取图像。为了省去图片底部的无关部分，以缩短亚像素边缘的计算时间，直接将图片横向裁剪，留下中间部分。然后对图像取反色，并抑制像素值为220以下的所有噪声。

倾斜纠正的方法比较粗暴：将样品旋转N度后，观察样品在竖直方向上的跨度L（图像不为0的部分最大索引与最小索引在竖直方向上的差），找到使跨度L最小的旋转角度N=argmin_N (L)，就是将工件调整到水平所需的旋转角。（函数 `tile_correction()`）

### 2.2 亚像素边缘检测和边缘提取

用亚像素的方法检测边缘。

亚像素检测，求得每一个边缘点的梯度幅值和方向，然后结合自身以及邻域像素，沿着梯度方向做拟合（这里用的是二次拟合），求出真实的边缘所在的位置，从而使边缘的位置更加准确。（函数 `tile_correction()` 中调用的函数 `subpixel_edge()`）

然后，进行边缘提取，按顺时针顺序获取一连串的边缘坐标。具体的边缘提取算法为：将某一个边缘点设为初始种子，在其顺时针的8领域以及16邻域内寻找临近的边缘像素点，若找到，就把新的边缘像素点设为新的种子。（函数 `gen_contours()`）

为了使该算法正常工作，需要保证亚像素边缘至少在16邻域内连续，因此，需要先对亚像素边缘进行闭运算。之后，再做小模板匹配，以去除噪点（函数 `thinner_edge()`）。然后才可以应用上述边缘提取算法。

### 2.3 矩形度评估

矩形度等于四边形自身的面积除以最小外接矩形的面积。

---

## 3. 缺陷检测

缺陷检测依次经过图像级、缺陷级和像素级三个层面。

### 3.1 图像层面

将图像取反色之后做倾斜校正。倾斜校正的结果保存在 `data/defect_correctedEdge/` 目录下。

观察到样品中除了缺陷的条纹，还存在着大量杂乱的周期性竖直条纹。将图像转换到频域，然后应用一个带通滤波器即可（函数 `eliminate_thin_curve()`）。

然后二值化并进行形态学操作，计算非0像素点的个数，越多越可能是缺陷样品。手动设定阈值为580。

### 3.2 缺陷层面

样品的噪声比较复杂，样品间光照强度不同，样品内光照也并不均匀，这使得二值化图像上存在较多的噪点，难以继续通过形态学的方法定位缺陷，这在很多样本上都能得到体现。

利用灰度共生矩阵。将图像分成15*20个不重叠的小块，计算每个小块的在不同方向的灰度共生矩阵GLCM，再得到GLCM的对比度Contrast，为对比度设定一个阈值α。通过这种方式，可以以这些小块为单元定位缺陷。（函数 `GLCM()`、`calculate_glcm()` 和 `extract_texture_features()`）

### 3.3 像素层面

现在我们只需要关注样品的一小部分，因此过滤掉了很多噪声。直接求图像梯度，在经过二值化和形态学处理后，得到像素级别的缺陷。

---

## 4. 总结与改进

以上步骤，实现了工业样品的倾斜矫正、矩形度计算，以及三个层面的缺陷检测。

在缺陷检测任务中：

- 图像层面的分类准确率为96%，其中无缺陷样品全部分类正确，缺陷样品召回率在37/41；
- 在缺陷层面，只对被识别出来的缺陷样品做处理，平均被覆盖率为81%；
- 在像素层面，平均被覆盖率为18%。

### 改进方向

- 倾斜矫正的方法，可以缩短运行时间；
- 在图像层面，灰度共生矩阵的计算太慢，可以事先对图像进行下采样。另外，不是每一小块都需要做灰度共生矩阵分析，可以在计算灰度共生矩阵前，先用某种方式估计小块的平坦度，决定是否跳过。